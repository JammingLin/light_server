<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<!-- autogenerated by 'erl2html2'. -->
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
<title>e:/lib/Emysql/test/environment_SUITE.erl</title>
</head>

<body bgcolor="white" text="black" link="blue" vlink="purple" alink="red">
<pre>
<a name="1"/>    1: <i>%%%-------------------------------------------------------------------</i>
<a name="2"/>    2: <i>%%% File     : Emysql/test/environment_SUITE.erl</i>
<a name="3"/>    3: <i>%%% Descr    : Suite #1 - testing the test setup, db and pathes =</i>
<a name="4"/>    4: <i>%%%            availability of crypto app, emysql app and test db. </i>
<a name="5"/>    5: <i>%%% Author   : H. Diedrich</i>
<a name="6"/>    6: <i>%%% Created  : 12/13/2011 hd</i>
<a name="7"/>    7: <i>%%% Requires : Erlang 14B (prior may not have ct_run)</i>
<a name="8"/>    8: <i>%%%-------------------------------------------------------------------</i>
<a name="9"/>    9: <i>%%%</i>
<a name="10"/>   10: <i>%%% THIS SUITE DOES NO ACTUAL TESTS BUT CHECKS THE TEST DATABASE ETC.</i>
<a name="11"/>   11: <i>%%% Test Cases are in this high granularity for clear failure reports.</i>
<a name="12"/>   12: <i>%%%</i>
<a name="13"/>   13: <i>%%% Run from Emysql/: </i>
<a name="14"/>   14: <i>%%%     make test</i>
<a name="15"/>   15: <i>%%%</i>
<a name="16"/>   16: <i>%%% Results see:</i>
<a name="17"/>   17: <i>%%%     test/index.html</i>
<a name="18"/>   18: <i>%%%</i>
<a name="19"/>   19: <i>%%%-------------------------------------------------------------------</i>
<a name="20"/>   20: 
<a name="21"/>   21: <b>-define</b>(POOL, environment_test_pool).
<a name="22"/>   22: 
<a name="23"/>   23: <b>-module</b>(environment_SUITE).
<a name="24"/>   24: <b>-include_lib</b>(&quot;common_test/include/ct.hrl&quot;).
<a name="25"/>   25: 
<a name="26"/>   26: <b>-include</b>(&quot;../include/emysql.hrl&quot;).
<a name="27"/>   27: 
<a name="28"/>   28: <b>-export</b>([
<a name="29"/>   29:         all/0,
<a name="30"/>   30: 	init_per_suite/1,
<a name="31"/>   31: 	end_per_suite/1,
<a name="32"/>   32:         init_per_testcase/2,
<a name="33"/>   33:         end_per_testcase/2,
<a name="34"/>   34: 
<a name="35"/>   35:         connecting_to_db_and_creating_a_pool_transition/1,
<a name="36"/>   36: 
<a name="37"/>   37:         add_pool_utf8/1,
<a name="38"/>   38:         add_pool_utf8_with_collate/1,
<a name="39"/>   39:         add_pool_utf8_deprecated/1,
<a name="40"/>   40:         add_pool_latin1/1,
<a name="41"/>   41:         add_pool_latin1_deprecated/1,
<a name="42"/>   42:         add_pool_latin1_compatible/1,
<a name="43"/>   43:         add_pool_latin1_compatible_deprecated/1,
<a name="44"/>   44:         add_pool_time_zone/1,
<a name="45"/>   45:         add_pool_time_zone_deprecated/1,
<a name="46"/>   46:         add_pool_wrong_db/1,
<a name="47"/>   47:         add_pool_wrong_cmd/1,
<a name="48"/>   48:         add_pool_port_should_be_a_number/1,
<a name="49"/>   49:         add_pool_size_should_be_a_number/1,
<a name="50"/>   50:         add_pool_timeout_should_be_a_number/1,
<a name="51"/>   51:         add_pool_env_defaults/1,
<a name="52"/>   52:         add_pool_env_all/1
<a name="53"/>   53: 
<a name="54"/>   54:     ]).
<a name="55"/>   55: 
<a name="56"/>   56: <i>% List of test cases.</i>
<a name="57"/>   57: <i>%%--------------------------------------------------------------------</i>
<a name="all-0"/><a name="58"/>   58: <b>all</b>() -&gt; 
<a name="59"/>   59:     [
<a name="60"/>   60:         connecting_to_db_and_creating_a_pool_transition,
<a name="61"/>   61: 
<a name="62"/>   62:         add_pool_utf8,
<a name="63"/>   63:         add_pool_utf8_with_collate,
<a name="64"/>   64:         add_pool_utf8_deprecated,
<a name="65"/>   65:         add_pool_latin1,
<a name="66"/>   66:         add_pool_latin1_deprecated,
<a name="67"/>   67:         add_pool_latin1_compatible,
<a name="68"/>   68:         add_pool_latin1_compatible_deprecated,
<a name="69"/>   69:         add_pool_time_zone,
<a name="70"/>   70:         add_pool_time_zone_deprecated,
<a name="71"/>   71:         add_pool_wrong_db,
<a name="72"/>   72:         add_pool_wrong_cmd,
<a name="73"/>   73:         add_pool_port_should_be_a_number,
<a name="74"/>   74:         add_pool_size_should_be_a_number,
<a name="75"/>   75:         add_pool_timeout_should_be_a_number,
<a name="76"/>   76:         add_pool_env_defaults,
<a name="77"/>   77:         add_pool_env_all
<a name="78"/>   78:     ].
<a name="79"/>   79: 
<a name="init_per_suite-1"/><a name="80"/>   80: <b>init_per_suite</b>(Config) -&gt;
<a name="81"/>   81:     crypto:start(),
<a name="82"/>   82:     application:start(emysql),
<a name="83"/>   83:     Config.
<a name="84"/>   84: 
<a name="end_per_suite-1"/><a name="85"/>   85: <b>end_per_suite</b>(Config) -&gt;
<a name="86"/>   86:     application:stop(emysql),
<a name="87"/>   87:     Config.
<a name="88"/>   88: 
<a name="init_per_testcase-2"/><a name="89"/>   89: <b>init_per_testcase</b>(add_pool_env_defaults, Config) -&gt;
<a name="90"/>   90:     ok = application:stop(emysql),
<a name="91"/>   91:     ok = application:set_env(emysql, pools, [{?POOL, [
<a name="92"/>   92:                     {user, test_helper:test_u()},
<a name="93"/>   93:                     {password, test_helper:test_p()},
<a name="94"/>   94:                     {host, &quot;localhost&quot;},
<a name="95"/>   95:                     {port, 3306}
<a name="96"/>   96:                 ]}]
<a name="97"/>   97:     ),
<a name="98"/>   98:     ok = application:start(emysql),
<a name="99"/>   99:     Config;
<a name="100"/>  100: 
<a name="101"/>  101: <b>init_per_testcase</b>(add_pool_env_all, Config) -&gt;
<a name="102"/>  102:     ok = application:stop(emysql),
<a name="103"/>  103:     ok = application:set_env(emysql, pools, [{?POOL, [
<a name="104"/>  104:                     {size, 10},
<a name="105"/>  105:                     {user, test_helper:test_u()},
<a name="106"/>  106:                     {password, test_helper:test_p()},
<a name="107"/>  107:                     {host, &quot;localhost&quot;},
<a name="108"/>  108:                     {port, 3306},
<a name="109"/>  109:                     {database, &quot;hello_database&quot;},
<a name="110"/>  110:                     {encoding, utf8},
<a name="111"/>  111:                     {start_cmds, [&lt;&lt;&quot;SET TIME_ZONE='+00:00'&quot;&gt;&gt;]}
<a name="112"/>  112:                 ]}]
<a name="113"/>  113:     ),
<a name="114"/>  114:     ok = application:start(emysql),
<a name="115"/>  115:     Config;
<a name="116"/>  116: 
<a name="117"/>  117: <i>%TODO: Probably better to split out test suite into ones that expect the pool to exist and </i>
<a name="118"/>  118: <i>% tests that are about setting up the pool.</i>
<a name="119"/>  119: 
<a name="120"/>  120: <b>init_per_testcase</b>(_TestCase, Config) -&gt;
<a name="121"/>  121:     Config.
<a name="122"/>  122: 
<a name="123"/>  123: <i>% If the test created a pool, we should remove it. Note that we should do this even</i>
<a name="124"/>  124: <i>% For the tests that are supposed to fail, in case they accidentally succeed.</i>
<a name="125"/>  125: 
<a name="end_per_testcase-2"/><a name="126"/>  126: <b>end_per_testcase</b>(_TestCase, _Config) -&gt;  
<a name="127"/>  127:     application:unset_env(emysql, pools),
<a name="128"/>  128:     catch emysql:remove_pool(?POOL);
<a name="129"/>  129: 
<a name="130"/>  130: <b>end_per_testcase</b>(_, _) -&gt;
<a name="131"/>  131:     ok.
<a name="132"/>  132: 
<a name="133"/>  133: <i>%% Test case: test obsolete transitional API</i>
<a name="134"/>  134: <i>%%--------------------------------------------------------------------</i>
<a name="connecting_to_db_and_creating_a_pool_transition-1"/><a name="135"/>  135: <b>connecting_to_db_and_creating_a_pool_transition</b>(_) -&gt;
<a name="136"/>  136:     emysql:add_pool(?POOL, [{user,test_helper:test_u()},
<a name="137"/>  137: 			    {password,test_helper:test_p()},
<a name="138"/>  138: 			    {database,&quot;hello_database&quot;},
<a name="139"/>  139: 			    {encoding, utf8}]),
<a name="140"/>  140:     #result_packet{rows=[[&lt;&lt;&quot;hello_database&quot;&gt;&gt;]]} =
<a name="141"/>  141: 	emysql:execute(?POOL, &lt;&lt;&quot;SELECT DATABASE();&quot;&gt;&gt;),
<a name="142"/>  142:     #result_packet{rows=[[&lt;&lt;&quot;utf8&quot;&gt;&gt;]]} =
<a name="143"/>  143: 	emysql:execute(?POOL, &lt;&lt;&quot;SELECT @@character_set_connection;&quot;&gt;&gt;).
<a name="144"/>  144: 
<a name="145"/>  145: 
<a name="add_pool_utf8-1"/><a name="146"/>  146: <b>add_pool_utf8</b>(_) -&gt;
<a name="147"/>  147:     emysql:add_pool(?POOL, [{user,test_helper:test_u()}, 
<a name="148"/>  148: 			    {password,test_helper:test_p()},
<a name="149"/>  149: 			    {encoding, utf8}]),
<a name="150"/>  150:     #result_packet{rows=[[&lt;&lt;&quot;utf8&quot;&gt;&gt;]]} =
<a name="151"/>  151:     emysql:execute(?POOL, &lt;&lt;&quot;SELECT @@character_set_connection;&quot;&gt;&gt;).
<a name="152"/>  152: 
<a name="add_pool_utf8_with_collate-1"/><a name="153"/>  153: <b>add_pool_utf8_with_collate</b>(_) -&gt;
<a name="154"/>  154:     emysql:add_pool(?POOL, [{user,test_helper:test_u()}, 
<a name="155"/>  155: 			    {password,test_helper:test_p()},
<a name="156"/>  156: 			    {encoding, {utf8, utf8_unicode_ci}}]),
<a name="157"/>  157:     #result_packet{rows=[[&lt;&lt;&quot;utf8_unicode_ci&quot;&gt;&gt;]]} =
<a name="158"/>  158:     emysql:execute(?POOL, &lt;&lt;&quot;select @@collation_connection;&quot;&gt;&gt;).
<a name="159"/>  159: 
<a name="160"/>  160: <i>% Note on deprecated tests: keeping while the add_pool/&gt;2 are still part of the api.</i>
<a name="add_pool_utf8_deprecated-1"/><a name="161"/>  161: <b>add_pool_utf8_deprecated</b>(_) -&gt;
<a name="162"/>  162:     emysql:add_pool(?POOL, 10, test_helper:test_u(), test_helper:test_p(),
<a name="163"/>  163:         &quot;localhost&quot;, 3306, undefined, utf8),
<a name="164"/>  164:     #result_packet{rows=[[&lt;&lt;&quot;utf8&quot;&gt;&gt;]]} =
<a name="165"/>  165:     emysql:execute(?POOL, &lt;&lt;&quot;SELECT @@character_set_connection;&quot;&gt;&gt;).
<a name="166"/>  166: 
<a name="add_pool_latin1-1"/><a name="167"/>  167: <b>add_pool_latin1</b>(_) -&gt;
<a name="168"/>  168:     emysql:add_pool(?POOL, [{user,test_helper:test_u()}, 
<a name="169"/>  169: 			    {password,test_helper:test_p()},
<a name="170"/>  170: 			    {encoding, latin1}]),
<a name="171"/>  171:     #result_packet{rows=[[&lt;&lt;&quot;latin1&quot;&gt;&gt;]]} =
<a name="172"/>  172:     emysql:execute(?POOL, &lt;&lt;&quot;SELECT @@character_set_connection;&quot;&gt;&gt;).
<a name="173"/>  173: 
<a name="add_pool_latin1_deprecated-1"/><a name="174"/>  174: <b>add_pool_latin1_deprecated</b>(_) -&gt;
<a name="175"/>  175:     emysql:add_pool(?POOL, 10, test_helper:test_u(), test_helper:test_p(),
<a name="176"/>  176:         &quot;localhost&quot;, 3306, undefined, latin1),
<a name="177"/>  177:     #result_packet{rows=[[&lt;&lt;&quot;latin1&quot;&gt;&gt;]]} =
<a name="178"/>  178:     emysql:execute(?POOL, &lt;&lt;&quot;SELECT @@character_set_connection;&quot;&gt;&gt;).
<a name="179"/>  179: 
<a name="add_pool_latin1_compatible-1"/><a name="180"/>  180: <b>add_pool_latin1_compatible</b>(_) -&gt;
<a name="181"/>  181:     emysql:add_pool(?POOL, [{user,test_helper:test_u()}, 
<a name="182"/>  182: 			    {password,test_helper:test_p()}]),
<a name="183"/>  183:     #result_packet{rows=[[&lt;&lt;&quot;latin1&quot;&gt;&gt;]]} =
<a name="184"/>  184:     emysql:execute(?POOL, &lt;&lt;&quot;SELECT @@character_set_connection;&quot;&gt;&gt;).
<a name="185"/>  185: 
<a name="add_pool_latin1_compatible_deprecated-1"/><a name="186"/>  186: <b>add_pool_latin1_compatible_deprecated</b>(_) -&gt;
<a name="187"/>  187:     emysql:add_pool(?POOL, 10, test_helper:test_u(), test_helper:test_p(),
<a name="188"/>  188:         &quot;localhost&quot;, 3306, undefined, undefined),
<a name="189"/>  189:     #result_packet{rows=[[&lt;&lt;&quot;latin1&quot;&gt;&gt;]]} =
<a name="190"/>  190:     emysql:execute(?POOL, &lt;&lt;&quot;SELECT @@character_set_connection;&quot;&gt;&gt;).
<a name="191"/>  191: 
<a name="192"/>  192: 
<a name="add_pool_time_zone-1"/><a name="193"/>  193: <b>add_pool_time_zone</b>(_) -&gt;
<a name="194"/>  194:     emysql:add_pool(?POOL, [{user,test_helper:test_u()}, 
<a name="195"/>  195: 			    {password,test_helper:test_p()},
<a name="196"/>  196: 			    {start_cmds,[&lt;&lt;&quot;SET time_zone='+00:00'&quot;&gt;&gt;]}]),
<a name="197"/>  197:     #result_packet{rows=[[&lt;&lt;&quot;+00:00&quot;&gt;&gt;]]} =
<a name="198"/>  198:     emysql:execute(?POOL, &lt;&lt;&quot;SELECT @@time_zone;&quot;&gt;&gt;).
<a name="199"/>  199: 
<a name="add_pool_time_zone_deprecated-1"/><a name="200"/>  200: <b>add_pool_time_zone_deprecated</b>(_) -&gt;
<a name="201"/>  201:     emysql:add_pool(?POOL, 10, test_helper:test_u(), test_helper:test_p(),
<a name="202"/>  202:         &quot;localhost&quot;, 3306, undefined, utf8, [&lt;&lt;&quot;SET time_zone='+00:00'&quot;&gt;&gt;]),
<a name="203"/>  203:     #result_packet{rows=[[&lt;&lt;&quot;+00:00&quot;&gt;&gt;]]} =
<a name="204"/>  204:     emysql:execute(?POOL, &lt;&lt;&quot;SELECT @@time_zone;&quot;&gt;&gt;).
<a name="205"/>  205: 
<a name="206"/>  206: 
<a name="add_pool_env_defaults-1"/><a name="207"/>  207: <b>add_pool_env_defaults</b>(_) -&gt;
<a name="208"/>  208:     #result_packet{rows=[[undefined]]} =
<a name="209"/>  209:     emysql:execute(?POOL, &lt;&lt;&quot;SELECT DATABASE();&quot;&gt;&gt;),
<a name="210"/>  210:     #result_packet{rows=[[&lt;&lt;&quot;latin1&quot;&gt;&gt;]]} =
<a name="211"/>  211:     emysql:execute(?POOL, &lt;&lt;&quot;SELECT @@character_set_connection;&quot;&gt;&gt;),
<a name="212"/>  212:     #result_packet{rows=[[&lt;&lt;&quot;SYSTEM&quot;&gt;&gt;]]} =
<a name="213"/>  213:     emysql:execute(?POOL, &lt;&lt;&quot;SELECT @@time_zone;&quot;&gt;&gt;).
<a name="214"/>  214: 
<a name="add_pool_env_all-1"/><a name="215"/>  215: <b>add_pool_env_all</b>(_) -&gt;
<a name="216"/>  216:     #result_packet{rows=[[&lt;&lt;&quot;hello_database&quot;&gt;&gt;]]} =
<a name="217"/>  217:     emysql:execute(?POOL, &lt;&lt;&quot;SELECT DATABASE();&quot;&gt;&gt;),
<a name="218"/>  218:     #result_packet{rows=[[&lt;&lt;&quot;utf8&quot;&gt;&gt;]]} =
<a name="219"/>  219:     emysql:execute(?POOL, &lt;&lt;&quot;SELECT @@character_set_connection;&quot;&gt;&gt;),
<a name="220"/>  220:     #result_packet{rows=[[&lt;&lt;&quot;+00:00&quot;&gt;&gt;]]} =
<a name="221"/>  221:     emysql:execute(?POOL, &lt;&lt;&quot;SELECT @@time_zone;&quot;&gt;&gt;).
<a name="222"/>  222: 
<a name="add_pool_wrong_db-1"/><a name="223"/>  223: <b>add_pool_wrong_db</b>(_) -&gt;
<a name="224"/>  224:     {Pid, Mref} = spawn_monitor(fun() -&gt;
<a name="225"/>  225:                 emysql:add_pool(?POOL, 10, test_helper:test_u(),
<a name="226"/>  226:                     test_helper:test_p(), &quot;localhost&quot;, 3306,
<a name="227"/>  227:                     &quot;this-database-does-not-exist&quot;, utf8
<a name="228"/>  228:                 )
<a name="229"/>  229:         end
<a name="230"/>  230:     ),
<a name="231"/>  231:     receive
<a name="232"/>  232:         {'DOWN', Mref, process, Pid,
<a name="233"/>  233:             {{nocatch, {failed_to_set_database, _}}, _}} -&gt;
<a name="234"/>  234:             ok
<a name="235"/>  235:     after 100 -&gt;
<a name="236"/>  236:             exit(should_have_failed)
<a name="237"/>  237:     end,
<a name="238"/>  238:     % Verify there are no connections added for real
<a name="239"/>  239:     [] = emysql_conn_mgr:pools().
<a name="240"/>  240: 
<a name="add_pool_wrong_cmd-1"/><a name="241"/>  241: <b>add_pool_wrong_cmd</b>(_) -&gt;
<a name="242"/>  242:     {Pid, Mref} = spawn_monitor(fun() -&gt;
<a name="243"/>  243:                 emysql:add_pool(?POOL, [{user,test_helper:test_u()},
<a name="244"/>  244: 					{password,test_helper:test_p()},
<a name="245"/>  245: 					{start_cmds,[&lt;&lt;&quot;syntax error&quot;&gt;&gt;]}])
<a name="246"/>  246:         end
<a name="247"/>  247:     ),
<a name="248"/>  248:     receive
<a name="249"/>  249:         {'DOWN', Mref, process, Pid, {{nocatch, {failed_to_run_cmd, _}}, _}} -&gt;
<a name="250"/>  250:             ok
<a name="251"/>  251:     after 100 -&gt;
<a name="252"/>  252:             exit(should_have_failed)
<a name="253"/>  253:     end,
<a name="254"/>  254:     % Verify there are no connections added for real
<a name="255"/>  255:     [] = emysql_conn_mgr:pools().
<a name="256"/>  256: 
<a name="add_pool_port_should_be_a_number-1"/><a name="257"/>  257: <b>add_pool_port_should_be_a_number</b>(_) -&gt;
<a name="258"/>  258:     {Pid, Mref} = spawn_monitor(fun() -&gt;
<a name="259"/>  259:                 emysql:add_pool(?POOL, [{user,test_helper:test_u()},
<a name="260"/>  260: 					{password,test_helper:test_p()},
<a name="261"/>  261: 					{port,&quot;NotANumber&quot;}])
<a name="262"/>  262:         end
<a name="263"/>  263:     ),
<a name="264"/>  264:     receive
<a name="265"/>  265:         {'DOWN', Mref, process, Pid, _} -&gt;
<a name="266"/>  266:             ok;
<a name="267"/>  267: 	_Other -&gt;
<a name="268"/>  268: 	    exit({unexpected,_Other})
<a name="269"/>  269: 
<a name="270"/>  270:     after 100 -&gt;
<a name="271"/>  271:             exit(should_have_failed)
<a name="272"/>  272:     end,
<a name="273"/>  273:     % Verify there are no connections added for real
<a name="274"/>  274:     [] = emysql_conn_mgr:pools().
<a name="275"/>  275: 
<a name="add_pool_size_should_be_a_number-1"/><a name="276"/>  276: <b>add_pool_size_should_be_a_number</b>(_) -&gt;
<a name="277"/>  277:     {Pid, Mref} = spawn_monitor(fun() -&gt;
<a name="278"/>  278:                 emysql:add_pool(?POOL, [{size,&quot;Ten&quot;}, 
<a name="279"/>  279: 					{user,test_helper:test_u()},
<a name="280"/>  280: 					{password,test_helper:test_p()}])
<a name="281"/>  281: 					
<a name="282"/>  282:         end
<a name="283"/>  283:     ),
<a name="284"/>  284:     receive
<a name="285"/>  285:         {'DOWN', Mref, process, Pid, _} -&gt;
<a name="286"/>  286:             ok;
<a name="287"/>  287: 	_Other -&gt;
<a name="288"/>  288: 	    exit({unexpected,_Other})
<a name="289"/>  289: 
<a name="290"/>  290:     after 100 -&gt;
<a name="291"/>  291:             exit(should_have_failed)
<a name="292"/>  292:     end,
<a name="293"/>  293:     % Verify there are no connections added for real
<a name="294"/>  294:     [] = emysql_conn_mgr:pools().
<a name="295"/>  295: 
<a name="add_pool_timeout_should_be_a_number-1"/><a name="296"/>  296: <b>add_pool_timeout_should_be_a_number</b>(_) -&gt;
<a name="297"/>  297:     {Pid, Mref} = spawn_monitor(fun() -&gt;
<a name="298"/>  298:                 emysql:add_pool([{user,test_helper:test_u()},
<a name="299"/>  299: 				 {password,test_helper:test_p()},
<a name="300"/>  300: 				 {connect_timeout,&quot;TimeoutNotANumber&quot;}])
<a name="301"/>  301:         end
<a name="302"/>  302:     ),
<a name="303"/>  303:     receive
<a name="304"/>  304:         {'DOWN', Mref, process, Pid, _} -&gt;
<a name="305"/>  305:             ok;
<a name="306"/>  306: 	_Other -&gt;
<a name="307"/>  307: 	    exit({unexpected,_Other})
<a name="308"/>  308: 
<a name="309"/>  309:     after 100 -&gt;
<a name="310"/>  310:             exit(should_have_failed)
<a name="311"/>  311:     end,
<a name="312"/>  312:     % Verify there are no connections added for real
<a name="313"/>  313:     [] = emysql_conn_mgr:pools().
</pre>
</body>
</html>
